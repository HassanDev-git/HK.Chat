<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HK Chat - Server Setup Instructions</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      line-height: 1.7;
      padding: 0;
    }
    .header {
      background: linear-gradient(135deg, #00a884, #008f6f);
      padding: 40px 20px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0,168,132,0.3);
    }
    .header h1 {
      font-size: 2.2em;
      color: #fff;
      margin-bottom: 8px;
    }
    .header p {
      color: rgba(255,255,255,0.85);
      font-size: 1.1em;
    }
    .header .ip-badge {
      display: inline-block;
      background: rgba(0,0,0,0.25);
      padding: 8px 20px;
      border-radius: 25px;
      margin-top: 12px;
      font-family: 'Courier New', monospace;
      font-size: 1.15em;
      color: #fff;
      letter-spacing: 1px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px 60px;
    }
    .info-box {
      background: #1a2e28;
      border-left: 4px solid #00a884;
      padding: 18px 22px;
      border-radius: 8px;
      margin: 20px 0 30px;
      font-size: 0.95em;
    }
    .info-box strong { color: #00a884; }
    .section {
      background: #111;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 28px;
      margin-bottom: 24px;
      transition: border-color 0.3s;
    }
    .section:hover { border-color: #00a884; }
    .section h2 {
      color: #00a884;
      font-size: 1.4em;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section h2 .step-num {
      background: #00a884;
      color: #000;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85em;
      font-weight: 700;
      flex-shrink: 0;
    }
    .section p {
      color: #aaa;
      margin-bottom: 14px;
      font-size: 0.95em;
    }
    pre {
      background: #0d1117;
      border: 1px solid #1a1a2e;
      border-radius: 8px;
      padding: 16px 20px;
      overflow-x: auto;
      font-family: 'Courier New', Consolas, monospace;
      font-size: 0.88em;
      line-height: 1.8;
      margin: 10px 0;
      position: relative;
    }
    pre code { color: #c9d1d9; }
    .cmd { color: #79c0ff; }
    .comment { color: #6a737d; font-style: italic; }
    .highlight { color: #ffa657; }
    .string { color: #a5d6ff; }
    .success { color: #3fb950; }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #222;
      color: #aaa;
      border: 1px solid #333;
      padding: 4px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.78em;
      transition: all 0.2s;
    }
    .copy-btn:hover { background: #00a884; color: #000; border-color: #00a884; }

    .warning {
      background: #2d1f00;
      border-left: 4px solid #f0883e;
      padding: 14px 18px;
      border-radius: 8px;
      margin: 14px 0;
      font-size: 0.9em;
      color: #f0883e;
    }

    .success-box {
      background: #0d2818;
      border-left: 4px solid #3fb950;
      padding: 14px 18px;
      border-radius: 8px;
      margin: 14px 0;
      font-size: 0.9em;
      color: #3fb950;
    }

    .quick-ref {
      background: #111;
      border: 2px solid #00a884;
      border-radius: 12px;
      padding: 24px;
      margin-top: 30px;
    }
    .quick-ref h2 { color: #00a884; margin-bottom: 16px; }
    .quick-ref table {
      width: 100%;
      border-collapse: collapse;
    }
    .quick-ref th {
      text-align: left;
      color: #00a884;
      padding: 8px 12px;
      border-bottom: 1px solid #333;
      font-size: 0.9em;
    }
    .quick-ref td {
      padding: 8px 12px;
      border-bottom: 1px solid #1a1a1a;
      font-size: 0.88em;
    }
    .quick-ref td code {
      background: #0d1117;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      color: #79c0ff;
    }

    .footer {
      text-align: center;
      padding: 30px;
      color: #555;
      font-size: 0.85em;
      border-top: 1px solid #1a1a1a;
      margin-top: 40px;
    }

    @media (max-width: 600px) {
      .header h1 { font-size: 1.6em; }
      .container { padding: 16px 12px 40px; }
      .section { padding: 18px; }
      pre { font-size: 0.8em; padding: 12px; }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>üü¢ HK Chat ‚Äî Server Setup Guide</h1>
    <p>Complete deployment instructions for DigitalOcean Ubuntu Droplet</p>
    <div class="ip-badge">üåê Server IP: 146.190.49.154</div>
  </div>

  <div class="container">

    <div class="info-box">
      <strong>üìã Prerequisites:</strong> A fresh Ubuntu 24.04 LTS droplet on DigitalOcean (or any VPS). 
      Root SSH access required. This guide covers Node.js 20, PM2, Nginx reverse proxy, and firewall setup.
    </div>

    <!-- STEP 1 -->
    <div class="section">
      <h2><span class="step-num">1</span> Connect & Update System</h2>
      <p>SSH into your droplet and update all packages.</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy</button><code><span class="comment"># SSH into server</span>
<span class="cmd">ssh</span> root@<span class="highlight">146.190.49.154</span>

<span class="comment"># Update system packages</span>
<span class="cmd">sudo apt update</span> && <span class="cmd">sudo apt upgrade -y</span></code></pre>
    </div>

    <!-- STEP 2 -->
    <div class="section">
      <h2><span class="step-num">2</span> Install Node.js 20 & Tools</h2>
      <p>Install Node.js 20.x, PM2 process manager, and build tools.</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy</button><code><span class="comment"># Add NodeSource repo & install Node.js 20</span>
<span class="cmd">curl -fsSL</span> https://deb.nodesource.com/setup_20.x | <span class="cmd">sudo -E bash -</span>
<span class="cmd">sudo apt install -y</span> nodejs

<span class="comment"># Verify installation</span>
<span class="cmd">node --version</span>    <span class="comment"># Should show v20.x.x</span>
<span class="cmd">npm --version</span>     <span class="comment"># Should show 10.x.x</span>

<span class="comment"># Install PM2 globally</span>
<span class="cmd">sudo npm install -g</span> pm2

<span class="comment"># Install build tools (needed for native modules like better-sqlite3)</span>
<span class="cmd">sudo apt install -y</span> build-essential python3 git</code></pre>
    </div>

    <!-- STEP 3 -->
    <div class="section">
      <h2><span class="step-num">3</span> Clone & Setup Project</h2>
      <p>Clone the repository and install all dependencies.</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy</button><code><span class="comment"># Go to home directory</span>
<span class="cmd">cd</span> /root

<span class="comment"># Clone the repo</span>
<span class="cmd">git clone</span> https://github.com/HassanDev-git/HK.Chat.git Web.HK.Chat
<span class="cmd">cd</span> Web.HK.Chat

<span class="comment"># Install all dependencies (root + server + client)</span>
<span class="cmd">npm run install-all</span>

<span class="comment"># Rebuild native modules for Linux</span>
<span class="cmd">cd</span> server && <span class="cmd">npm rebuild</span> better-sqlite3 && <span class="cmd">cd</span> ..

<span class="comment"># Build the client for production</span>
<span class="cmd">npm run build</span>

<span class="comment"># Create required directories</span>
<span class="cmd">mkdir -p</span> logs server/uploads/{images,videos,audio,voice,documents,profiles,status} server/data</code></pre>
    </div>

    <!-- STEP 4 -->
    <div class="section">
      <h2><span class="step-num">4</span> Start with PM2</h2>
      <p>Launch the server using PM2 process manager with auto-restart on reboot.</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy</button><code><span class="comment"># Start the server using ecosystem config</span>
<span class="cmd">pm2 start</span> ecosystem.config.js

<span class="comment"># Check status ‚Äî should show "online"</span>
<span class="cmd">pm2 status</span>

<span class="comment"># View logs to confirm startup</span>
<span class="cmd">pm2 logs</span> hkchat-server --lines 15

<span class="comment"># Save process list & enable auto-start on reboot</span>
<span class="cmd">pm2 save</span>
<span class="cmd">pm2 startup</span></code></pre>

      <div class="warning">
        ‚ö†Ô∏è <strong>Important:</strong> Only ONE process should run on port 5000. If you see <code>EADDRINUSE</code> error, 
        check <code>pm2 status</code> for duplicate processes and delete extras with <code>pm2 delete &lt;name&gt;</code>.
      </div>

      <div class="success-box">
        ‚úÖ Test: <code>curl http://localhost:5000/api/health</code> ‚Äî should return <code>{"status":"ok"}</code>
      </div>
    </div>

    <!-- STEP 5 -->
    <div class="section">
      <h2><span class="step-num">5</span> Configure Firewall (UFW)</h2>
      <p>Open required ports and enable the firewall.</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy</button><code><span class="cmd">sudo ufw allow</span> 22/tcp     <span class="comment"># SSH</span>
<span class="cmd">sudo ufw allow</span> 80/tcp     <span class="comment"># HTTP (Nginx)</span>
<span class="cmd">sudo ufw allow</span> 443/tcp    <span class="comment"># HTTPS (future SSL)</span>
<span class="cmd">sudo ufw allow</span> 5000/tcp   <span class="comment"># Direct server access</span>
<span class="cmd">sudo ufw --force enable</span>
<span class="cmd">sudo ufw status</span></code></pre>
    </div>

    <!-- STEP 6 -->
    <div class="section">
      <h2><span class="step-num">6</span> Setup Nginx Reverse Proxy</h2>
      <p>Configure Nginx to proxy port 80 ‚Üí 5000 with WebSocket support.</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy</button><code><span class="comment"># Install Nginx</span>
<span class="cmd">sudo apt install -y</span> nginx

<span class="comment"># Create site config</span>
<span class="cmd">sudo tee</span> /etc/nginx/sites-available/hkchat > /dev/null << <span class="string">'EOF'</span>
server {
    listen 80;
    server_name <span class="highlight">146.190.49.154</span>;

    client_max_body_size 50M;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }
}
<span class="string">EOF</span>

<span class="comment"># Enable site & remove default</span>
<span class="cmd">sudo ln -sf</span> /etc/nginx/sites-available/hkchat /etc/nginx/sites-enabled/
<span class="cmd">sudo rm -f</span> /etc/nginx/sites-enabled/default

<span class="comment"># Test & restart Nginx</span>
<span class="cmd">sudo nginx -t</span>
<span class="cmd">sudo systemctl restart nginx</span>
<span class="cmd">sudo systemctl enable nginx</span></code></pre>

      <div class="success-box">
        ‚úÖ Now visit: <strong>http://<span style="color:#ffa657">146.190.49.154</span></strong> ‚Äî HK Chat should load!
      </div>
    </div>

    <!-- STEP 7 -->
    <div class="section">
      <h2><span class="step-num">7</span> Updating / Redeployment</h2>
      <p>When you push new code to GitHub, run these commands on the server to update.</p>
      <pre><button class="copy-btn" onclick="copyCode(this)">Copy</button><code><span class="cmd">cd</span> /root/Web.HK.Chat

<span class="comment"># Pull latest changes</span>
<span class="cmd">git pull origin main</span>

<span class="comment"># Reinstall dependencies (if package.json changed)</span>
<span class="cmd">npm run install-all</span>

<span class="comment"># Rebuild client</span>
<span class="cmd">npm run build</span>

<span class="comment"># Restart server</span>
<span class="cmd">pm2 restart</span> hkchat-server
<span class="cmd">pm2 save</span></code></pre>
    </div>

    <!-- QUICK REFERENCE -->
    <div class="quick-ref">
      <h2>‚ö° Quick Reference Commands</h2>
      <table>
        <thead>
          <tr><th>Action</th><th>Command</th></tr>
        </thead>
        <tbody>
          <tr><td>Check server status</td><td><code>pm2 status</code></td></tr>
          <tr><td>View live logs</td><td><code>pm2 logs hkchat-server</code></td></tr>
          <tr><td>Restart server</td><td><code>pm2 restart hkchat-server</code></td></tr>
          <tr><td>Stop server</td><td><code>pm2 stop hkchat-server</code></td></tr>
          <tr><td>Delete process</td><td><code>pm2 delete hkchat-server</code></td></tr>
          <tr><td>Health check</td><td><code>curl http://localhost:5000/api/health</code></td></tr>
          <tr><td>Nginx status</td><td><code>sudo systemctl status nginx</code></td></tr>
          <tr><td>Nginx restart</td><td><code>sudo systemctl restart nginx</code></td></tr>
          <tr><td>Firewall status</td><td><code>sudo ufw status</code></td></tr>
          <tr><td>Check port 5000</td><td><code>sudo lsof -i :5000</code></td></tr>
          <tr><td>Kill port 5000</td><td><code>sudo fuser -k 5000/tcp</code></td></tr>
          <tr><td>Rebuild native deps</td><td><code>cd server && npm rebuild better-sqlite3</code></td></tr>
        </tbody>
      </table>
    </div>

    <!-- TROUBLESHOOTING -->
    <div class="section" style="margin-top: 30px;">
      <h2><span class="step-num">?</span> Troubleshooting</h2>
      
      <p><strong style="color:#f0883e;">EADDRINUSE error (port 5000 in use):</strong></p>
      <pre><code><span class="comment"># Check what's using port 5000</span>
<span class="cmd">sudo lsof -i :5000</span>

<span class="comment"># Check for duplicate PM2 processes</span>
<span class="cmd">pm2 status</span>

<span class="comment"># Delete ALL and start fresh</span>
<span class="cmd">pm2 delete all</span>
<span class="cmd">pm2 start</span> ecosystem.config.js
<span class="cmd">pm2 save</span></code></pre>

      <p><strong style="color:#f0883e;">502 Bad Gateway from Nginx:</strong></p>
      <pre><code><span class="comment"># Make sure PM2 server is running</span>
<span class="cmd">pm2 status</span>   <span class="comment"># Should show "online"</span>
<span class="cmd">pm2 restart</span> hkchat-server

<span class="comment"># Check Nginx config</span>
<span class="cmd">sudo nginx -t</span>
<span class="cmd">sudo systemctl restart nginx</span></code></pre>

      <p><strong style="color:#f0883e;">better-sqlite3 build error:</strong></p>
      <pre><code><span class="cmd">sudo apt install -y</span> build-essential python3
<span class="cmd">cd</span> /root/Web.HK.Chat/server
<span class="cmd">npm rebuild</span> better-sqlite3
<span class="cmd">pm2 restart</span> hkchat-server</code></pre>
    </div>

    <div class="footer">
      HK Chat &copy; 2026 ‚Äî Server IP: <strong>146.190.49.154</strong> | 
      GitHub: <a href="https://github.com/HassanDev-git/HK.Chat" style="color:#00a884;">HassanDev-git/HK.Chat</a>
    </div>

  </div>

  <script>
    function copyCode(btn) {
      const pre = btn.parentElement;
      const code = pre.querySelector('code').innerText;
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'Copied!';
        btn.style.background = '#00a884';
        btn.style.color = '#000';
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.style.background = '#222';
          btn.style.color = '#aaa';
        }, 2000);
      });
    }
  </script>

</body>
</html>
